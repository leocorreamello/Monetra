<div class="graficos-container">
  <!-- Header principal - apenas quando n√£o h√° transa√ß√µes -->
  <div class="graficos-header" 
       *ngIf="filteredTransactions.length === 0">
    <div class="header-title">
      <h1>An√°lise Financeira</h1>
      <p class="header-subtitle">Visualize seus dados financeiros atrav√©s de gr√°ficos interativos</p>
    </div>
    
    <!-- Se√ß√£o de controles -->
    <div class="controls-section">
      <!-- Upload de arquivo -->
      <div class="file-upload-zone">
        <input type="file" accept=".pdf,.csv" (change)="onFileSelected($event)" />
        <div class="upload-icon">üìà</div>
        <h3 class="upload-title">Enviar Extrato para An√°lise</h3>
        <p class="upload-subtitle">Arraste seu arquivo aqui ou clique para selecionar</p>
      </div>
    </div>
  </div>

  <!-- Layout principal com sidebar -->
  <div class="main-content" [class.with-charts]="filteredTransactions.length > 0">
    <!-- Container da sidebar - agrupa upload + filtros verticalmente -->
    <div class="sidebar-container">
      <!-- Upload Sidebar - apenas quando h√° transa√ß√µes -->
      <div class="upload-sidebar" *ngIf="filteredTransactions.length > 0">
        <div class="upload-header">
          <div class="header-title">
            <h1>üìÑ Upload</h1>
            <p class="header-subtitle">Adicionar extratos</p>
          </div>
          
          <div class="controls-section">
            <div class="file-upload-zone">
              <input type="file" accept=".pdf,.csv" (change)="onFileSelected($event)" />
              <div class="upload-icon">üìÑ</div>
              <h3 class="upload-title">Enviar Extrato</h3>
              <p class="upload-subtitle">Clique aqui</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar de filtros -->
      <div class="filters-sidebar" [class.standalone]="filteredTransactions.length === 0">
        <div class="sidebar-title">
          üîç <span>Filtros</span>
        </div>
        
        <div class="filters-list">
          <!-- Filtros de per√≠odo -->
          <div class="filter-group">
            <label class="filter-label">Ano</label>
            <select class="compact-select" [(ngModel)]="selectedAno" (change)="applyFilters()">
              <option value="">Todos</option>
              <option *ngFor="let ano of uniqueAnos" [value]="ano">{{ ano }}</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">M√™s</label>
            <select class="compact-select" [(ngModel)]="selectedMes" (change)="applyFilters()">
              <option value="">Todos</option>
              <option *ngFor="let mes of uniqueMeses" [value]="mes">{{ getMonthName(mes) }}</option>
            </select>
          </div>
          
          <!-- Filtros de categoria e tipo -->
          <div class="filter-group">
            <label class="filter-label">Categoria</label>
            <select class="compact-select" [(ngModel)]="selectedCategoria" (change)="applyFilters()">
              <option value="">Todas</option>
              <option *ngFor="let categoria of categorias" [value]="categoria">
                {{ getCategoryDisplayName(categoria) }}
              </option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Tipo</label>
            <select class="compact-select" [(ngModel)]="selectedTipo" (change)="applyFilters()">
              <option value="">Todos</option>
              <option value="entrada">‚¨Ü Entradas</option>
              <option value="saida">‚¨á Sa√≠das</option>
            </select>
          </div>
        </div>
        
        <div class="sidebar-actions">
          <button 
            class="sidebar-button clear-button" 
            (click)="clearFilters()"
            [disabled]="!hasActiveFilters()">
            üóÇÔ∏è Limpar
          </button>
        </div>
      </div>
    </div>

    <!-- √Årea de conte√∫do principal - gr√°ficos -->
    <div class="content-area" [class.with-sidebar]="filteredTransactions.length > 0">
      <!-- Loading state -->
      <div class="loading-container" *ngIf="isLoading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Processando seus dados financeiros...</p>
      </div>

      <!-- Gr√°ficos modernos -->
      <div class="charts-grid fade-in" *ngIf="filteredTransactions.length > 0 && !isLoading">
        <!-- Resumo financeiro -->
        <div class="summary-cards">
          <div class="summary-card entrada">
            <div class="card-icon">‚¨ÜÔ∏è</div>
            <div class="card-content">
              <h3>Total Entradas</h3>
              <p class="card-value">{{ formatCurrency(getTotalEntradas()) }}</p>
            </div>
          </div>
          
          <div class="summary-card saida">
            <div class="card-icon">‚¨áÔ∏è</div>
            <div class="card-content">
              <h3>Total Sa√≠das</h3>
              <p class="card-value">{{ formatCurrency(getTotalSaidas()) }}</p>
            </div>
          </div>
          
          <div class="summary-card saldo">
            <div class="card-icon">üí∞</div>
            <div class="card-content">
              <h3>Saldo Per√≠odo</h3>
              <p class="card-value" [class.positive]="isSaldoPositivo()" 
                 [class.negative]="isSaldoNegativo()">
                {{ formatCurrency(getSaldoPeriodo()) }}
              </p>
            </div>
          </div>
        </div>

        <!-- Grid de gr√°ficos -->
        <div class="charts-container">
          <!-- Gr√°fico de Linha Temporal - NOVO SIMPLES -->
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Evolu√ß√£o Temporal</h3>
              <p class="chart-subtitle">Entradas vs Sa√≠das ao longo do tempo</p>
            </div>
            <div class="chart-content">
              @if (hasLineChartData()) {
              <div class="line-chart-simple">
                <!-- Legenda -->
                <div class="chart-legend-simple">
                  <div class="legend-item">
                    <span class="legend-color" style="background-color: #10b981;"></span>
                    <span>Entradas</span>
                  </div>
                  <div class="legend-item">
                    <span class="legend-color" style="background-color: #ef4444;"></span>
                    <span>Sa√≠das</span>
                  </div>
                </div>

                <!-- SVG Chart -->
                <div class="svg-container">
                  <svg viewBox="0 80 1000 390" class="line-svg">
                    <!-- Gradientes -->
                    <defs>
                      <linearGradient id="greenGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="rgba(16, 185, 129, 0.4)" />
                        <stop offset="100%" stop-color="rgba(16, 185, 129, 0.1)" />
                      </linearGradient>
                      <linearGradient id="redGradient" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stop-color="rgba(239, 68, 68, 0.4)" />
                        <stop offset="100%" stop-color="rgba(239, 68, 68, 0.1)" />
                      </linearGradient>
                    </defs>

                    <!-- Grid horizontal -->
                    @for (yLabel of getYLabels(getChartData().maxValue); track yLabel.value) {
                    <line 
                      [attr.x1]="120" 
                      [attr.y1]="yLabel.y"
                      [attr.x2]="900" 
                      [attr.y2]="yLabel.y"
                      stroke="rgba(255, 255, 255, 0.1)" 
                      stroke-width="1">
                    </line>
                    }

                    <!-- √Årea de entradas -->
                    <path 
                      [attr.d]="getAreaPath(getChartData().entradas, getChartData().maxValue)"
                      fill="url(#greenGradient)">
                    </path>

                    <!-- √Årea de sa√≠das -->
                    <path 
                      [attr.d]="getAreaPath(getChartData().saidas, getChartData().maxValue)"
                      fill="url(#redGradient)">
                    </path>

                    <!-- Linha de entradas -->
                    <path 
                      [attr.d]="getLinePoints(getChartData().entradas, getChartData().maxValue)"
                      stroke="#10b981" 
                      stroke-width="3" 
                      fill="none"
                      stroke-linecap="round">
                    </path>

                    <!-- Linha de sa√≠das -->
                    <path 
                      [attr.d]="getLinePoints(getChartData().saidas, getChartData().maxValue)"
                      stroke="#ef4444" 
                      stroke-width="3" 
                      fill="none"
                      stroke-linecap="round">
                    </path>

                    <!-- Labels Y -->
                    @for (yLabel of getYLabels(getChartData().maxValue); track yLabel.value) {
                    <text 
                      [attr.x]="110" 
                      [attr.y]="yLabel.y + 4"
                      fill="rgba(255, 255, 255, 0.7)" 
                      font-size="16" 
                      text-anchor="end">
                      {{ yLabel.label }}
                    </text>
                    }

                    <!-- Labels X (mostrar apenas dias espec√≠ficos: 1, 5, 10, 15, 20, 25, 30) -->
                    @for (label of getChartData().labels; track label; let i = $index) {
                      @if ([0, 4, 9, 14, 19, 24, 29].includes(i)) {
                        <text 
                          [attr.x]="120 + (i * 780) / mathMax(getChartData().labels.length - 1, 1)"
                          y="470"
                          fill="rgba(255, 255, 255, 0.7)" 
                          font-size="16" 
                          text-anchor="middle">
                          {{ label }}
                        </text>
                      }
                    }

                    <!-- Pontos invis√≠veis para hover -->
                    @for (point of getHoverPoints(); track point.x) {
                    <circle 
                      [attr.cx]="point.x"
                      [attr.cy]="point.y"
                      r="20"
                      fill="transparent"
                      class="hover-point"
                      (mouseenter)="onLineHover(point, $event)"
                      (mouseleave)="onLineLeave()">
                    </circle>
                    }
                  </svg>

                  <!-- Tooltip -->
                  @if (hoverInfo.visible) {
                  <div class="line-tooltip" 
                       [style.left.px]="hoverInfo.x"
                       [style.top.px]="hoverInfo.y">
                    <div class="tooltip-title">{{ hoverInfo.day }}</div>
                    <div class="tooltip-item green">
                      <span class="tooltip-label">Entradas:</span>
                      <span class="tooltip-value">{{ formatCurrency(hoverInfo.entradas) }}</span>
                    </div>
                    <div class="tooltip-item red">
                      <span class="tooltip-label">Sa√≠das:</span>
                      <span class="tooltip-value">{{ formatCurrency(hoverInfo.saidas) }}</span>
                    </div>
                  </div>
                  }
                </div>

                <!-- Resumo -->
                <div class="chart-summary">
                  <div class="summary-stat">
                    <span class="stat-label">Total Entradas</span>
                    <span class="stat-value green">{{ formatCurrency(getTotalEntradas()) }}</span>
                  </div>
                  <div class="summary-stat">
                    <span class="stat-label">Total Sa√≠das</span>
                    <span class="stat-value red">{{ formatCurrency(getTotalSaidas()) }}</span>
                  </div>
                </div>
              </div>
              } @else {
              <div class="empty-chart">
                <div class="empty-icon">ÔøΩ</div>
                <h4>Sem dados para exibir</h4>
                <p>Fa√ßa upload de extratos para visualizar a evolu√ß√£o temporal.</p>
              </div>
              }
            </div>
          </div>

          <!-- Gr√°fico de Pizza -->
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Gastos por Categoria</h3>
              <p class="chart-subtitle">Distribui√ß√£o dos gastos</p>
            </div>
            <div class="chart-content">
              <div class="pie-chart" *ngIf="pieChartData.labels.length > 0">
                <!-- Gr√°fico de Pizza em SVG -->
                <div class="pie-svg-container">
                  <svg class="pie-svg" viewBox="0 0 200 200" width="280" height="280">
                    <!-- Centro do gr√°fico -->
                    <circle cx="100" cy="100" r="35" fill="rgba(15, 23, 42, 0.9)" stroke="rgba(255, 255, 255, 0.2)" stroke-width="2"/>
                    
                    <!-- Fatias do gr√°fico -->
                    <g class="pie-slices">
                      <path *ngFor="let slice of getPieSlices(); let i = index"
                            [attr.d]="slice.path"
                            [attr.fill]="pieChartData.datasets[0].backgroundColor[i]"
                            [attr.stroke]="'rgba(255, 255, 255, 0.3)'"
                            [attr.stroke-width]="2"
                            class="pie-slice-path"
                            [style.animation-delay]="i * 0.1 + 's'">
                      </path>
                    </g>
                    
                    <!-- Labels das porcentagens -->
                    <g class="pie-labels">
                      <text *ngFor="let slice of getPieSlices(); let i = index"
                            [attr.x]="slice.labelX"
                            [attr.y]="slice.labelY"
                            class="pie-label"
                            text-anchor="middle"
                            dominant-baseline="middle"
                            [style.animation-delay]="i * 0.15 + 's'">
                        {{ slice.percentage }}%
                      </text>
                    </g>
                    
                    <!-- Texto central -->
                    <text x="100" y="95" class="pie-center-text" text-anchor="middle" dominant-baseline="middle">
                      Total
                    </text>
                    <text x="100" y="110" class="pie-center-value" text-anchor="middle" dominant-baseline="middle">
                      {{ formatCurrency(getTotalSaidas()) }}
                    </text>
                  </svg>
                  

                </div>
              </div>
              
              <!-- Legenda melhorada -->
              <div class="chart-legend">
                <div class="legend-item" 
                     *ngFor="let label of pieChartData.labels; let i = index">
                  <div class="legend-color-wrapper">
                    <span class="legend-color" 
                          [style.background-color]="pieChartData.datasets[0].backgroundColor[i]"></span>
                    <span class="legend-percentage">{{ getPieSlicePercentage(i) }}%</span>
                  </div>
                  <div class="legend-content">
                    <span class="legend-text">{{ label }}</span>
                    <span class="legend-value">{{ formatCurrency(pieChartData.datasets[0].data[i]) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Gr√°fico de Barras -->
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Comparativo por Categoria</h3>
              <p class="chart-subtitle">Entradas vs Sa√≠das por categoria</p>
            </div>
            <div class="chart-content">
              <div class="bar-chart" *ngIf="barChartData.labels.length > 0">
                <canvas id="barChart" width="400" height="200"></canvas>
                <!-- Simula√ß√£o visual do gr√°fico de barras -->
                <div class="bar-simulation">
                  <div class="bar-group" *ngFor="let label of barChartData.labels; let i = index">
                    <div class="bar-label">{{ label.split(' ')[1] || label }}</div>
                    <div class="bar-values">
                      <div class="bar entrada" 
                           [style.height.%]="getBarHeightPercentage(0, i)"
                           title="Entradas: {{ formatCurrency(barChartData.datasets[0].data[i]) }}">
                      </div>
                      <div class="bar saida" 
                           [style.height.%]="getBarHeightPercentage(1, i)"
                           title="Sa√≠das: {{ formatCurrency(barChartData.datasets[1].data[i]) }}">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Estado vazio melhorado -->
      <div class="empty-state" *ngIf="filteredTransactions.length === 0 && !isLoading">
        <div class="empty-state-content">
          <div class="empty-state-icon">
            <span *ngIf="transactions.length === 0">üìä</span>
            <span *ngIf="transactions.length > 0">üîç</span>
          </div>
          <h3 class="empty-state-title">
            {{ transactions.length === 0 ? 'Visualize suas Finan√ßas!' : 'Nenhum resultado encontrado' }}
          </h3>
          <p class="empty-state-text">
            {{ transactions.length === 0 ? 
                'Fa√ßa upload do seu extrato banc√°rio (PDF ou CSV) para gerar gr√°ficos e an√°lises inteligentes dos seus dados financeiros.' : 
                'Ajuste os filtros acima para encontrar as transa√ß√µes que voc√™ est√° procurando.' }}
          </p>
          <div class="empty-state-actions" *ngIf="transactions.length === 0">
            <div class="supported-formats">
              <small>Formatos suportados:</small>
              <div class="format-badges">
                <span class="format-badge">üìÑ PDF</span>
                <span class="format-badge">üìä CSV</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>